<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>安親慈善基金會｜可信專業的公益行動</title>
    <meta
      name="description"
      content="財團法人臺北市安親慈善基金會致力於關懷弱勢與促進社會和諧，邀請你一起以善為根、以愛為行。"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=Noto+Serif+TC:wght@600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container nav">
        <div class="brand">
          <img class="logo-img" src="logo.png" alt="安親慈善基金會標誌" />
          <div>
            <p class="brand-name">安親慈善基金會</p>
            <p class="brand-tagline">以善為根・以愛為行</p>
          </div>
        </div>
        <nav class="nav-links">
          <a href="about.html">關於我們</a>
          <a href="programs.html">服務計畫</a>
          <a href="transparency.html">透明公開</a>
          <a href="news.html">最新消息</a>
          <a href="volunteer.html">志工加入</a>
          <a href="contact.html">聯絡我們</a>
          <a class="primary" href="donate.html">立即捐款</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="page-hero">
        <div class="container hero-layout">
          <div>
            <p class="eyebrow">財團法人臺北市安親慈善基金會</p>
            <h1>深耕社會每個需要的角落</h1>
            <p class="lead">
              在快速變遷的社會裡，我們相信溫暖與陪伴不該缺席。安親慈善基金會秉持
              「民族精神・和睦鄉里・濟老愛幼・服務社會」的宗旨，結合現代公益理念，
              長期關懷弱勢族群、促進社會和諧。
            </p>
            <div class="hero-actions">
              <a class="primary" href="donate.html">成為定期定額捐款人</a>
              <a class="ghost" href="programs.html">了解服務計畫</a>
            </div>
            <p class="callout">善是一種信仰，愛是一種行動。</p>
          </div>
          <div class="hero-card">
            <p class="tag">線上捐款平台已開通</p>
            <h3>你的支持，成為他人的依靠</h3>
            <p class="lead">
              捐款將用於兒少扶助、長者關懷、社區共好與急難救助，讓資源帶來可持續的改變。
            </p>
            <a class="primary" href="donate.html">前往捐款</a>
          </div>
        </div>
      </section>

      <section class="section alt">
        <div class="container">
          <div class="section-head">
            <p class="eyebrow">服務焦點</p>
            <h2>以實際行動，溫柔守護需要的人</h2>
            <p>我們推動多元服務計畫，陪伴兒少、長者與社區，並在災難與急難時及時伸出援手。</p>
          </div>
          <div class="grid-3">
            <div class="panel">
              <h3>弱勢兒童與身心障礙者扶助</h3>
              <p>提供教養、教育、醫療與生活支持，守護成長路上的安全感。</p>
            </div>
            <div class="panel">
              <h3>高齡長者關懷</h3>
              <p>透過探訪、物資援助與節慶關懷，讓長者不再孤單。</p>
            </div>
            <div class="panel">
              <h3>社區和睦與文化傳承</h3>
              <p>舉辦講座、公益活動與志工服務，凝聚社會向心力。</p>
            </div>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="container">
          <div class="section-head">
            <p class="eyebrow">最新消息</p>
            <h2>最新 6 筆活動與公告</h2>
            <p>內容由管理員於 Google 試算表更新，首頁自動顯示最新六則。</p>
          </div>
          <div id="news-latest" class="grid-3"></div>
          <div style="margin-top: 20px;">
            <a class="ghost" href="news.html">查看全部消息</a>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="container hero-layout">
          <div>
            <p class="eyebrow">透明承諾</p>
            <h2>讓每一份支持都被看見</h2>
            <p>
              我們承諾公開年度成果與資源運用摘要，並以專業治理回應每一份信任。
            </p>
            <a class="ghost" href="transparency.html">查看透明公開</a>
          </div>
          <div class="panel">
            <h3>捐款去向摘要</h3>
            <p>將資源投入服務與急難救助，確保每一筆支持真正回到需要的地方。</p>
            <ul class="simple-list">
              <li>兒少扶助與教育支持</li>
              <li>高齡長者關懷與訪視</li>
              <li>社區共好與急難救助</li>
            </ul>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-grid">
        <div>
          <p class="brand-name">財團法人臺北市安親慈善基金會</p>
          <p>以善為根・以愛為行</p>
        </div>
        <div>
          <p class="footer-title">聯絡資訊</p>
          <p>電話：(02)2788-1008</p>
          <p>信箱：anching2025@gmail.com</p>
          <p>地址：台北市忠孝東路六段278巷23弄29號</p>
        </div>
        <div>
          <p class="footer-title">快速連結</p>
          <a href="programs.html">服務計畫</a>
          <a href="transparency.html">透明公開</a>
          <a href="donate.html">捐款支持</a>
        </div>
        <div>
          <p class="footer-title">登記資訊</p>
          <p>法人登記證書：114年度法登他字第000136號</p>
          <p>核准立案字號：北市社(4)字第39655號函</p>
        </div>
      </div>
    </footer>
    <script>
      const SHEET_ID = "12Q5MX69gfwJPv3X0t9mw3HUgPPOiGE4Lq7EeeIWF9hE";
      const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
      const PUBLISHED_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vR2u68dup_nVFtwCwjLNznK08tksnLjc7uTvGqbfrfzGR0oyB39RW882RuBMqL6oJFyZnqrlI0BNszu/pub?output=csv";
      const PUBLISHED_GVIZ_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vR2u68dup_nVFtwCwjLNznK08tksnLjc7uTvGqbfrfzGR0oyB39RW882RuBMqL6oJFyZnqrlI0BNszu/gviz/tq?tqx=out:json";

      function parseGviz(text) {
        const json = text.replace("/*O_o*/\\n", "").replace("google.visualization.Query.setResponse(", "").slice(0, -2);
        return JSON.parse(json);
      }

      function parseDateValue(value) {
        if (!value) return "";
        if (typeof value === "string" && value.startsWith("Date(")) {
          const parts = value.replace("Date(", "").replace(")", "").split(",").map(Number);
          if (parts.length >= 3) {
            const date = new Date(parts[0], parts[1], parts[2]);
            return date.toISOString().slice(0, 10);
          }
        }
        return value;
      }

      function toDateValue(value) {
        if (!value) return 0;
        const normalized = parseDateValue(value);
        const date = new Date(normalized);
        return Number.isNaN(date.getTime()) ? 0 : date.getTime();
      }

      function normalizeImageUrl(url) {
        if (!url) return "";
        if (url.includes("drive.google.com/uc?id=")) return url;
        const fileMatch = url.match(/drive\\.google\\.com\\/file\\/d\\/([^/]+)/);
        if (fileMatch) return `https://drive.google.com/uc?id=${fileMatch[1]}`;
        const openMatch = url.match(/drive\\.google\\.com\\/open\\?id=([^&]+)/);
        if (openMatch) return `https://drive.google.com/uc?id=${openMatch[1]}`;
        return url;
      }

      function buildCard(item) {
        const article = document.createElement("article");
        article.className = "panel";
        if (item.image_url) {
          const img = document.createElement("img");
          img.src = item.image_url;
          img.alt = item.title;
          img.loading = "lazy";
          img.style.borderRadius = "14px";
          img.style.marginBottom = "12px";
          article.appendChild(img);
        }
        const tag = document.createElement("p");
        tag.className = "tag";
        tag.textContent = item.date;
        const title = document.createElement("h3");
        title.textContent = item.title;
        const summary = document.createElement("p");
        summary.textContent = item.summary;
        article.append(tag, title, summary);
        if (item.link) {
          const link = document.createElement("a");
          link.className = "ghost";
          link.href = item.link;
          link.target = "_blank";
          link.rel = "noreferrer";
          link.textContent = "更多內容";
          link.style.display = "inline-block";
          link.style.marginTop = "12px";
          article.appendChild(link);
        }
        return article;
      }

      function parseCsv(text) {
        const delimiter = text.split("\n")[0]?.includes("\t") ? "\t" : ",";
        const rows = [];
        let current = [];
        let value = "";
        let inQuotes = false;
        for (let i = 0; i < text.length; i += 1) {
          const char = text[i];
          const next = text[i + 1];
          if (char === "\"" && inQuotes && next === "\"") {
            value += "\"";
            i += 1;
            continue;
          }
          if (char === "\"") {
            inQuotes = !inQuotes;
            continue;
          }
          if (char === delimiter && !inQuotes) {
            current.push(value);
            value = "";
            continue;
          }
          if ((char === "\n" || char === "\r") && !inQuotes) {
            if (value.length || current.length) {
              current.push(value);
              rows.push(current);
              current = [];
              value = "";
            }
            continue;
          }
          value += char;
        }
        if (value.length || current.length) {
          current.push(value);
          rows.push(current);
        }
        if (rows.length && rows[0][0]) {
          rows[0][0] = rows[0][0].replace(/^\uFEFF/, "");
        }
        return rows;
      }

      function fetchCsvFallback(onSuccess, onError) {
        const CSV_URL =
          PUBLISHED_CSV_URL || `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
        fetch(CSV_URL)
          .then((res) => res.text())
          .then((text) => {
            const rows = parseCsv(text);
            onSuccess(rows);
          })
          .catch(onError);
      }

      function loadSheetData(onSuccess, onError) {
        const script = document.createElement("script");
        const timeout = setTimeout(() => {
          fetchCsvFallback(onSuccess, onError);
        }, 8000);

        window.google = window.google || {};
        window.google.visualization = window.google.visualization || {};
        window.google.visualization.Query = window.google.visualization.Query || {};
        window.google.visualization.Query.setResponse = (response) => {
          clearTimeout(timeout);
          onSuccess(response);
          script.remove();
        };

        const gvizUrl = PUBLISHED_GVIZ_URL || SHEET_URL;
        script.src = `${gvizUrl}&gid=0&cachebust=${Date.now()}`;
        script.onerror = () => {
          clearTimeout(timeout);
          fetchCsvFallback(onSuccess, onError);
        };
        document.body.appendChild(script);
      }

      loadSheetData(
        (data) => {
          let header = [];
          let rows = [];
          if (Array.isArray(data)) {
            header = data[0] || [];
            rows = data.slice(1).map((row) => row.map((cell) => ({ v: cell })));
          } else {
            header = (data.table.cols || []).map((col) => col.label || "").map((h) => h.toLowerCase().trim());
            rows = data.table.rows || [];
          }

          const headerIndex = {};
          header.forEach((name, idx) => {
            if (!name) return;
            const key = name.toLowerCase().replace(/\s+/g, "_").trim();
            headerIndex[key] = idx;
          });

          const alias = {
            "image url": "image_url",
            "image-url": "image_url",
            "imageurl": "image_url",
            "date": "date",
            "title": "title",
            "summary": "summary",
            "link": "link",
          };

          const readCell = (row, key, fallbackIndex) => {
            const mapped = alias[key] || key;
            const idx = headerIndex[mapped];
            if (typeof idx === "number") return row[idx]?.v || row.c?.[idx]?.v || "";
            return row[fallbackIndex]?.v || row.c?.[fallbackIndex]?.v || "";
          };

          const items = rows.map((row) => ({
            date: parseDateValue(readCell(row, "date", 0)),
            title: readCell(row, "title", 1),
            summary: readCell(row, "summary", 2),
            image_url: normalizeImageUrl(readCell(row, "image_url", 3)),
            link: readCell(row, "link", 4),
          }));
          items.sort((a, b) => toDateValue(b.date) - toDateValue(a.date));
          const latest = items.slice(0, 6);
          const container = document.getElementById("news-latest");
          container.innerHTML = "";
          latest.forEach((item) => container.appendChild(buildCard(item)));
        },
        () => {
          const container = document.getElementById("news-latest");
          container.innerHTML =
            "<p>目前無法載入最新消息，請確認試算表已發佈到網路，或改用 GitHub Pages 開啟本站。</p>";
        }
      );
    </script>
  </body>
</html>
